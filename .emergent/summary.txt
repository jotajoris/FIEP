<analysis>**original_problem_statement:**
The user requested a web platform to manage purchase orders (OCs) for their client, FIEP.

**PRODUCT REQUIREMENTS (New in this session are bolded):**
- Create OCs manually or by uploading single/multiple PDFs.
- Implement a drag-and-drop UI for PDF uploads.
- Automatically assign items to responsible users.
- Track item status (, , , , , ).
- Two user roles:  and .
- Forgot Password and user profile editing functionality.
- A page to view all items assigned to a specific person.
- A dashboard with search, filtering, and bulk actions.
- An admin-only feature to edit any detail of an existing OC.
- A system to track package deliveries.
- A summary page showing key financial metrics.
- Format all monetary values in Brazilian standard (R$).
- Provide a backup and restore functionality.
- An Observação text field for each item.
- Breakdown of item counts by status on the Dashboard.
- Allow editing all fields on the OC creation preview screen.
- An autocomplete field for suppliers (Fornecedor).
- On the Em Separação page, manage supplier/sales invoices (Notas Fiscais).
- Extract NCM codes and item lists from supplier invoices.
- Detect and flag duplicate supplier invoices.
- Implement site-wide pagination and bulk download for invoices.
- Refactor Sales Invoice (NF de Venda) to be one per OC, allowing partial item selection.
- Display Observação field in item view, editable only in the edit form.
- For pending items, display a history of previous quotations.
- Extract and display the delivery date () from OC PDFs, with countdowns and admin editing.
- Display the full, editable delivery address () at the OC level.
- Allow safe OC data updates by re-uploading its PDF without losing item-specific data.
- On the Em Separação page, allow bulk status changes and application of shipping costs to selected items.
- Automatically record  when an item's status becomes .
- A Quantidade Comprada field for items.
- A new Estoque (Stock) page for surplus items and a Planilha de Itens (Item Sheet) for a consolidated view.
- Indicate if a new OC item is already available in stock.
- **Implement a Use from Stock feature for pending items.**
    - **Use the original purchase price for cost calculation.**
    - **If stock fully covers the need, change the item's status to .**
    - **If partially covered, create a partial purchase record and leave the remaining quantity as .**
    - **Record which OC the stock was used for.**
- **Allow uploading images for items via drag-and-drop, with a thumbnail view and a popup for the full image.**
- **On the Pendentes tab, group items with the same code from different OCs to allow for bulk quoting.**
- **When quoting an item, display the total quantity needed for that item across all OCs.**
- **On the Estoque page, allow admins to manually edit or delete stock entries.**
- **On the Estoque page, allow manually adding items to stock by searching for their code.**

**User's preferred language**:
The user's primary language is **Portuguese (Brazil)**. The next agent MUST respond in Portuguese.

**what currently exists?**
A full-stack Purchase Order management application (FastAPI + React) with core features for creating, tracking, and managing OCs. The application includes user roles, PDF parsing, status tracking, and a dashboard. The last sessions focused heavily on building out a stock management system. This system can track surplus items from purchases, and the user can now use this available stock to fulfill new item requirements. A UI for managing and viewing stock was also built, along with admin controls for editing and deleting stock entries. However, the logic for calculating and debiting stock has been a persistent source of bugs.

**Last working item**:
- **Last item agent was working:** The agent was fixing a recurring bug where the stock quantity was miscalculated. The user reported that after resetting a test and buying 10 units of an item that needed 1 (which should result in 9 units in stock), the system showed only 7. The agent identified that old stock usage data () was not being cleared from the source OC item when the destination OC item was reverted to Pendente, causing the calculation to be off (10 purchased - 1 needed - 2 (stale usage) = 7).
- **Status:** IN PROGRESS
- **Agent Testing Done:** Y (The agent created a temporary admin endpoint  to manually clear the stale data, which successfully corrected the stock count to 9. However, a permanent, automated solution has not been implemented.)
- **Which testing method agent to use?** Both. A backend testing agent should be used to create tests that simulate the status change flow (e.g.,  ->  -> ) and verify that all related fields (, , ) are correctly reset. A frontend testing agent should then verify that the UI reflects these changes accurately.
- **User Testing Done:** Y (The user discovered and reported the bug).

**All Pending/In progress Issue list**:
- **Issue 1: (P0)** Stock calculation is incorrect due to stale data.
- **Issue 2: (P1)** Editing duplicate items opens all of them for editing simultaneously.

**Issues Detail:**
- **Issue 1: Stock calculation is incorrect due to stale data**
    - **Attempted fixes:** The agent created a manual admin endpoint () to wipe the slate clean. This confirms the diagnosis but is not a real fix. The core logic that updates item statuses does not clean up related stock usage fields when an item is reverted to /.
    - **Next debug checklist:**
        1.  Modify the backend endpoints responsible for changing an item's status (e.g., ,  in ).
        2.  When an item's status is changed *back* to  or , the logic must also find the corresponding source OC item (from ) and decrement its  value.
        3.  The logic must also clear the  flag and  entry related to ESTOQUE INTERNO on the item being reverted.
        4.  Create a button on the Estoque page UI that calls the temporary admin endpoint as a stop-gap for the user to self-correct any existing data corruption while the permanent fix is being built.
    - **Why fix this issue and what will be achieved with the fix?** This is the core blocker for the entire stock management feature. Without accurate accounting, the feature is unusable and actively corrupts data.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Both.
    - **Blocked on other issue:** None.

- **Issue 2: Editing duplicate items opens all of them**
    - **Attempted fixes:** None in this session. The agent confirmed the code uses , but a deeper investigation is needed.
    - **Next debug checklist:**
        1.  Investigate state management in .
        2.  While  uses , the state for the *form data itself* might be shared or incorrectly keyed, causing all instances to show the same form.
        3.  Ensure that when  is called, the form data state ( or similar) is initialized specifically for .
    - **Why fix this issue and what will be achieved with the fix?** This is a long-standing, frustrating usability bug. Fixing it will significantly improve the user experience.
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

**In progress Task List**:
None. The focus is on fixing the critical stock bug.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **(P0)** Group identical pending items for bulk quoting.
    - **(P0)** Allow uploading images for items.
    - **(P1)** Show total quantity needed for an item on the quoting screen.
- **Future Tasks:**
    - **(P2)** Refactor the monolithic  and  files.
    - **(P3)** Provide guidance on deploying the application to Hostinger.
    - **(P3)** Guide the user on verifying their Resend domain.
    - **(P3)** Investigate a more reliable, paid Correios API for package tracking.

**Completed work in this session**
- **Feature:** Implemented the Use from Stock feature, including the backend endpoint () and a frontend modal in .
- **Feature:** Added admin controls to the Estoque page to edit quantities, delete stock origins, and manually add new items to stock.
- **Bug Fix:** Corrected the profit calculation logic to use the item's required quantity, not the total purchased quantity, and created a migration endpoint to fix historical data.
- **Bug Fix:** Fixed the initial bug where the stock page was empty.
- **Bug Fix:** Corrected multiple logical flaws in the stock calculation (, , etc.) to prioritize  over the  field and to exclude items attended by stock from generating new surplus.
- **Bug Fix:** Fixed a bug in the Use from Stock modal that allowed using more stock than required by the item.
- **Bug Fix:** Fixed a bug where the Use from Stock modal would incorrectly claim an item was already fulfilled if its status had been reverted from Comprado back to Pendente.
- **UI Improvement:** The Estoque page now details how many units from a stock source have been used and for which OCs.
- **UI Improvement:** Added an indicator on pending/quoted items to show how many units of that item are available in stock.

**Earlier issues found/mentioned but not fixed**
- **Issue 1:** Editing duplicate items opens all instances for editing simultaneously. (See All Pending/In progress Issue list for details).

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Editing duplicate items opens all of them.
- **Recurrence count:** 4+
- **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Motor (async MongoDB), Pydantic.
- **Frontend:** React (Hooks), Axios, TailwindCSS.
- **Complex Stock Logic:** The core of the recent work. Involves MongoDB aggregation pipelines and intricate cross-document updates to track stock generation, usage, and depletion. The logic relies on fields like , , , and .
- **Data Corruption & Manual Fixes:** The complexity of the stock logic has led to data inconsistencies, requiring the creation of one-off admin endpoints for correction (e.g., , ).

**key DB schema**
- **** (collection):
    -  (array of objects):
        - : (Optional[int]) Total quantity purchased. Often overridden by .
        - : (Optional[Array]) Detailed list of purchase sources.
        - ****: (Optional[int]) Tracks how many units from *this item's surplus* have been used by other OCs.
        - ****: (Optional[Array]) A log of which OCs used stock from this item. 
        - ****: (Optional[bool]) Flag indicating this item's need was fulfilled from stock, so it doesn't generate its own surplus.
        - ****: (Optional[int]) Tracks how many units *this item received* from the stock.

**All files of reference**
- : CRITICAL. All backend logic for stock calculation, usage, editing, and bug fixing resides here. Multiple new endpoints were added.
- : CRITICAL. Contains the UI and logic for the Use from Stock feature, including the trigger button and the interaction modal.
- : CRITICAL. Contains the UI for displaying the stock, and the modals for editing quantities, deleting stock origins, and adding new items to stock manually.
- : Updated with the new Use from Stock feature.

**Areas that need refactoring**:
- : **CRITICAL PRIORITY.** This file has become even larger and more complex. The stock logic is spread across multiple endpoints and is very difficult to reason about. It must be broken down into separate router files (, , etc.).
- : **CRITICAL PRIORITY.** This component manages an enormous amount of state for item display, editing, bulk actions, and now the Use from Stock modal. It should be decomposed into custom hooks and smaller components.

**key api endpoints**
- : Uses available stock to fulfill an item's need.
- : Manually edits the  of a stock source item.
- : Deletes a purchase source from an item, effectively removing it from stock.
- : Gets detailed stock availability for a specific item code.
- : **Temporary endpoint** to clear all stock usage data for debugging.
- : Main endpoint to list all items currently in stock. (Heavily modified).
- : Returns a simple map of . (Heavily modified).

**Critical Info for New Agent**
- **Your immediate and highest priority is to create a permanent fix for the stock calculation bug.** The current fix is a manual admin endpoint. You need to build the logic into the status update flow to automatically and correctly reverse stock usage when an item's status is reverted (e.g., from Comprado back to Pendente). Without this, the user will constantly face data corruption.
- After fixing the stock bug, the user's next priorities are: (1) Grouping identical pending items, (2) Adding item image uploads, (3) Showing total item needs on the quote screen. Address these in order.
- The user is very hands-on and tests features immediately. Expect rapid feedback and bug reports. Be prepared to debug complex data states.

**documents and test reports created in this job**
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Bug):** The Use from Stock modal says an item is já foi totalmente atendido even after I move it back to pendente.
2.  **User (Request):** I need buttons to edit and delete items from the stock page.
3.  **Agent (Fix):** Implemented edit/delete buttons and fixed the modal bug.
4.  **User (Bug):** I bought 10 units of an item needing 1, but it's not showing up in stock.
5.  **Agent (Fix):** Fixed the stock calculation logic to correctly prioritize purchase sources (). Implemented a more advanced stock editing/adding UI.
6.  **User (Bug):** The item is in stock, but when I click to use it, the modal says Não há estoque disponível.
7.  **Agent (Fix):** Fixed another logic error in the  endpoint that was causing the discrepancy.
8.  **User (Bug):** When I use stock, it isn't being debited correctly. Example: stock was 9, I used 2, it should be 7, but it's still 9.
9.  **Agent (Fix):** Added an  flag to prevent items that *receive* stock from also generating *new* stock, which fixed the debiting logic.
10. **User (Bug - LATEST/BLOCKER):** The stock calculation is wrong again. I reset the test, bought 10 for an item needing 1 (should be 9 in stock). The stock shows only 7, because it's incorrectly counting 2 units that were used in a previous test that I already reverted.

**Project Health Check:**
- **Broken:** The stock management feature is functionally broken and corrupts its own data over time because it lacks logic to handle status reversions.
- **Mocked:** Forgot Password functionality via Resend (domain not verified).
- **Technical Debt:** CRITICAL.  is now a massive, fragile monolith. The stock logic is convoluted and spread across numerous endpoints, making it extremely bug-prone.

**3rd Party Integrations**
- **Resend:** For emails.
- **PyMuPDF:** For parsing PDFs.
- **SeuRastreio API:** For package tracking (inactive).
- **APScheduler:** For background jobs.

**Testing status**
- **Testing agent used after significant changes:** YES, an initial suite of 13 tests was created and passed, but it did not cover the complex edge cases of reverting item statuses, which later caused bugs.
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** 
- **Known regressions:** The stock calculation logic regressed multiple times as new complexity was added.

**Credentials to test flow:**
- **Admin Login (João):**
    - **Email:** 
    - **Password:** 
- **User Login (Maria):**
    - **Email:** 
    - **Password:** 

**What agent forgot to execute**
- The agent failed to implement a permanent, automated solution for the stock data corruption issue. Instead, they created a manual admin endpoint () as a temporary patch, leaving the underlying logical flaw in place.
- The long-standing P1 bug of duplicate items opening for editing was not addressed.</analysis>
