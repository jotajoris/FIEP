<analysis>**original_problem_statement:**
The user requested a web platform to manage purchase orders (OCs) for their client, FIEP.

**PRODUCT REQUIREMENTS (New in this session are bolded):**
- Create OCs manually or by uploading single/multiple PDFs.
- Implement a drag-and-drop UI for PDF uploads.
- Automatically assign items to responsible users.
- Track item status (, , , , , ).
- Two user roles:  and .
- Forgot Password and user profile editing functionality.
- A page to view all items assigned to a specific person.
- A dashboard with search, filtering, and bulk actions.
- An admin-only feature to edit any detail of an existing OC.
- A system to track package deliveries.
- A summary page showing key financial metrics.
- Format all monetary values in Brazilian standard (R$).
- An Observação text field for each item.
- Breakdown of item counts by status on the Dashboard.
- Allow editing all fields on the OC creation preview screen.
- An autocomplete field for suppliers (Fornecedor).
- On the Em Separação page, manage supplier/sales invoices (Notas Fiscais).
- Extract NCM codes and item lists from supplier invoices.
- Detect and flag duplicate supplier invoices.
- Implement site-wide pagination and bulk download for invoices.
- Display Observação field in item view, editable only in the edit form.
- For pending items, display a history of previous quotations.
- Extract and display the delivery date () from OC PDFs, with countdowns and admin editing.
- Display the full, editable delivery address () at the OC level.
- Allow safe OC data updates by re-uploading its PDF without losing item-specific data.
- On the Em Separação page, allow bulk status changes and application of shipping costs to selected items.
- Automatically record  when an item's status becomes .
- A Quantidade Comprada field for items.
- A new Estoque (Stock) page for surplus items and a Planilha de Itens (Item Sheet) for a consolidated view.
- Indicate if a new OC item is already available in stock.
- Implement a Use from Stock feature for pending items.
- Allow uploading images for items via drag-and-drop, with a thumbnail view and a popup for the full image.
- On the Pendentes tab, group items with the same code from different OCs to allow for bulk quoting and editing.
- On the Estoque page, allow admins to manually edit or delete stock entries.
- A Planilha de Contrato page showing all items from an Excel file, cross-referencing their status within the app.
- Extend the Grouped View functionality to the Cotados page to allow for bulk purchasing.
- When using an item from stock, automatically copy all its data (price, photo, notes, supplier, etc.).
- Link an uploaded image to the item's CODE, so it appears for all instances of that item.
- Implement partial purchase: when buying a portion of a quoted item, the purchased quantity moves to Comprados and the remainder stays in Cotados.
- Persist uploaded images in the database so they are not lost on deploy.
- Handle scanned/image-based PDFs by implementing OCR.
- On the Em Separação page, sort OCs marked Pronto para Despacho to the top.
- On the Em Trânsito page, add the ability to add/edit tracking codes in bulk (per-item, per-selection, or per-OC).
- Integrate the Correios API to automatically update tracking status and send notifications to admins.
- Simplify the UI on the Em Trânsito page to hide financial data and show a clean, expandable view of tracking events.
- **Allow manual status changes for items on the Em Trânsito page, both individually and in bulk.**
- **On the Em Separação page, add the ability to change the status of items when applying freight and tracking in bulk.**
- **Implement a Partial Shipment feature to move a specific quantity of an item from Em Separação to Em Trânsito, leaving the remainder.**
- **Add a separate upload button for XML files for sales invoices (NF de Venda).**
- **Remove the static text EMPRESA OPTANTE PELO SIMPLES NACIONAL from the additional invoice data section.**
- **Implement automatic CEP lookup based on the delivery address.**

**User's preferred language**:
The user's primary language is **Portuguese (Brazil)**. The next agent MUST respond in Portuguese.

**what currently exists?**
A full-stack Purchase Order management application (FastAPI + React). This session was extremely productive, focused on resolving critical bugs and implementing a large number of user-requested features, primarily within the  component.

Key achievements include:
- **P0 Bug Fixes:** The two main P0 bugs were addressed.
  - The Correios API integration was debugged. The system now correctly uses the user's contract to track their own packages and provides a clear manual lookup link for packages not associated with the contract. This behavior was tested and approved by the user.
  - The bug where supplier invoices (Notas Fiscais) were not appearing was investigated and confirmed to be resolved by the testing agent.
- **Bulk Actions & Partial Shipments:** A significant number of features were added to enhance user workflow:
  - **Partial Shipment:** Users can now split an item in Em Separação, sending a partial quantity to Em Trânsito while the rest remains.
  - **Bulk Actions on Em Separação:** The bulk form for applying freight and tracking now also includes a dropdown to change the status of selected items (e.g., to Em Trânsito) simultaneously.
  - **Bulk Actions on Em Trânsito:** A similar bulk action form was implemented for the Em Trânsito page, allowing users to update tracking codes, freight costs, and status for multiple items at once. A manual status change button was also added to individual items.
- **UI/UX Enhancements:**
  - Separate Upload PDF and Upload XML buttons were added for sales invoices.
  - The static text EMPRESA OPTANTE PELO SIMPLES NACIONAL was removed as requested.
  - A manual CEP lookup feature was added to the delivery address editor.

**Last working item**:
- **Last item agent was working:** Implementing **automatic** CEP lookup. The user requested that instead of manually entering a CEP to search, the system should automatically find the CEP based on the existing delivery address text. The agent successfully created a Python script to test this logic using the ViaCEP API, created a backend utility function () and a new API endpoint (), and started adding a corresponding  function to the frontend.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** frontend testing agent. The agent needs to integrate the  function into the  component so it's called when the address editor is displayed, and then update the UI with the fetched CEP.
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: (P0)** Finish implementing automatic CEP lookup from the address string.
- **Issue 2: (P1)** Editing an item that appears in multiple OCs (duplicate) opens all instances for editing simultaneously.
- **Issue 3: (P2)** Performance issues on Em Separação page, exacerbated by the addition of many new features to the monolithic .
- **Issue 4: (P2)** Dashboard search by item code is not working.

**Issues Detail:**
- **Issue 1: Finish implementing automatic CEP lookup**
    - **Attempted fixes:** The backend endpoint and utility function are complete and tested. A frontend function  has been created in .
    - **Next debug checklist:**
        1. In , call the  function when the address editor component is rendered or when the Editar button for the address is clicked.
        2. Ensure the state for the CEP () is updated with the result from the API call.
        3. Verify the input field for the CEP displays the automatically fetched value.
    - **Why fix this issue and what will be achieved with the fix?** Fulfills a direct user request to automate a data entry step, improving workflow efficiency.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

- **Issue 2: Editing duplicate items opens all instances for editing**
    - **Attempted fixes:** None in this session.
    - **Next debug checklist:**
        1. Investigate state management in .
        2. The  state likely uses a non-unique identifier like . Refactor it to use the  of the specific item instance to control edit mode visibility.
    - **Why fix this issue and what will be achieved with the fix?** Fixes a long-standing, highly frustrating UI bug for the user.
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

- **Issue 3: Performance issues on Em Separação page**
    - **Attempted fixes:** Previous agent started refactoring, but this agent added significant new logic and state to , likely worsening the problem.
    - **Next debug checklist:** Continue the refactoring started in the previous session. Prioritize extracting the main item rendering loop and the new modal/form components into separate, memoized files.
    - **Why fix this issue and what will be achieved with the fix?** Improves usability on a critical page that is becoming slow and difficult to maintain.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

- **Issue 4: Dashboard search by item code is not working**
    - **Attempted fixes:** None in this session.
    - **Next debug checklist:**
        1. Verify frontend logic in  is correctly filtering based on user input.
        2. Inspect the API response from  to ensure it contains the necessary item data for searching.
    - **Why fix this issue and what will be achieved with the fix?** Restores a core navigation feature for users.
    - **Status:** USER VERIFICATION PENDING
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

**In progress Task List**:
- **Task 1: (P1)** Backend Refactoring
    - **Where to resume:** Continue extracting endpoints from  into modular files in . The file has grown again with new endpoints.
    - **What will be achieved with this?** A more maintainable, scalable, and less error-prone backend codebase.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Backend.
    - **Blocked on something:** Blocked by P0/P1 bug fixes.

- **Task 2: (P1)** Frontend Refactoring
    - **Where to resume:** Continue breaking down the  monolith. This is now more critical than ever, as the file has absorbed all the new features from this session and is likely well over 7,000 lines.
    - **What will be achieved with this?** Improved frontend performance, readability, and maintainability.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on something:** Blocked by P0/P1 bug fixes.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - (P2) Complete the backend refactoring of .
  - (P2) Complete the frontend refactoring of .
- **Future Tasks:**
  - (P3) Add a Create OC button directly on the Planilha de Contrato page for items that don't have an OC yet.
  - (P3) Extend the Grouped View functionality to the Em Separação page.

**Completed work in this session**
- **Bug Fix: Correios API Integration:** Stabilized the tracking feature. The system now successfully tracks items associated with the user's contract and provides a manual lookup link for all other items.
- **Bug Fix: Notas Fiscais Not Appearing:** Investigated and confirmed via  and the  that the backend endpoint is working correctly. The issue is considered resolved.
- **Feature: Partial Shipment:** Implemented a feature allowing users to send a partial quantity of an item to Em Trânsito while the remainder stays in Em Separação.
- **Feature: Bulk Actions on Em Trânsito:** Added a form to the Em Trânsito page to update tracking codes, freight costs, and status for multiple selected items simultaneously.
- **Feature: Bulk Status Change on Em Separação:** Enhanced the existing bulk freight/tracking form to also allow changing the item status at the same time.
- **Feature: Manual Status Change:** Added a button to each item on the Em Trânsito page to allow for individual manual status changes.
- **UI: Separate NF Uploads:** Replaced the single sales invoice upload button with two distinct buttons for Subir PDF and Subir XML.
- **UI: Address/CEP Lookup:** Added a CEP field and manual search button to the address editor.
- **UI: Text Removal:** Removed the static EMPRESA OPTANTE PELO SIMPLES NACIONAL text from the invoice data section.

**Earlier issues found/mentioned but not fixed**
- **Issue 1:** (P1) Editing duplicate items opens all instances for editing simultaneously. This is a recurring issue that has been deprioritized in favor of new features.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Editing duplicate items opens all of them.
- **Recurrence count:** 7+
- **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **Robust API Fallback:** The agent implemented a solid fallback for the Correios API. It tries the authenticated endpoint first; if that fails due to the object not belonging to the contract, it provides a direct manual link for the user, ensuring functionality is never fully lost.
- **Item Splitting (Partial Shipment):** A new backend endpoint () was created to duplicate an item document in MongoDB, splitting its quantity between the original and the new document, and updating their statuses accordingly.
- **Component-Driven State Management:** New features were added by introducing new state variables (e.g., , ) and functions at the top level of  and passing them down as props to child components like  and various modals.

**key DB schema**
- No changes to the database schema were made in this session.

**All files of reference**
- : **CRITICAL**. This monolithic file was the target of almost all feature implementations and modifications in this session. Its size and complexity have increased significantly.
- : **CRITICAL**. Modified extensively to add multiple new endpoints for partial shipments and bulk updates (, , , ).
- : Modified to include a status dropdown.
- : Overwritten and modified to include freight costs and a status dropdown.
- : Modified to add a manual status change dropdown.
- : Modified to handle the SRO-009: Objeto não pertence ao contrato error gracefully.

**Areas that need refactoring**:
- : **CRITICAL PRIORITY.** This file is now dangerously large and complex. It urgently needs to be broken down into smaller, manageable components to improve performance and maintainability.
- : **CRITICAL PRIORITY.** This file also continues to grow. The refactoring effort to move routes into separate files must be resumed.

**key api endpoints**
- : (NEW) Splits an item for partial shipment.
- : (NEW) Updates the status for multiple items in bulk.
- : (NEW) Updates tracking code and freight for multiple items on the Em Trânsito page.
- : (NEW) Takes an address string and returns a likely CEP using the ViaCEP API.

**Critical Info for New Agent**
- **IMMEDIATE PRIORITY:** Complete the **automatic CEP lookup** feature. The backend is done; you need to wire up the frontend in  to call the  endpoint when the address editor is displayed and populate the CEP field.
- **USER PRIORITIES:** The user has consistently prioritized new features over fixing technical debt. After the CEP feature, the next logical P1 issue is the long-standing bug with **editing duplicate items**.
- **TECHNICAL DEBT:** The  and  monoliths have grown significantly. You must advocate for and continue the refactoring tasks to prevent the application from becoming unmaintainable. The performance issues on the Em Separação page are a direct symptom of this debt.

**documents and test reports created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Request):** Asked for automatic CEP lookup from the address string. (IN PROGRESS)
2.  **User (Request):** Asked for three UI changes: separate XML upload, CEP lookup, and removal of a text string from the invoice data section. (COMPLETED)
3.  **User (Request):** Asked to add bulk status change functionality to the Em Trânsito page. (COMPLETED)
4.  **User (Request):** Asked for a Partial Shipment feature. (COMPLETED)
5.  **User (Clarification):** Confirmed the Partial Shipment should be implemented like the existing Partial Purchase feature. (COMPLETED)
6.  **User (Request):** Asked to add a status change option to the bulk freight/tracking form on the Em Separação page. (COMPLETED)
7.  **User (Clarification):** Rejected the inline editing of freight/tracking and asked for the bulk form from Em Separação to be replicated on the Em Trânsito page. (COMPLETED)
8.  **User (Request):** Asked for the ability to edit the freight value on the Em Trânsito page. (IMPLEMENTED, THEN REVERTED in favor of a better solution).
9.  **User (Request):** Asked for a button to manually change the status of items on the Em Trânsito page. (COMPLETED)
10. **User (Clarification):** Explained their use case for the Correios API, which led the agent to the final, correct implementation. (COMPLETED)

**Project Health Check:**
- **Broken:**
  - The implementation of automatic CEP lookup is half-finished.
- **Technical Debt:**
  - **CRITICAL:**  is now a massive monolith (likely 7000+ lines) containing dozens of features, states, and modals. Its complexity is the primary source of bugs and performance issues. Refactoring is no longer optional; it's essential for project stability.
  - **CRITICAL:**  has also grown with several new endpoints, making the need for modularization more urgent.

**3rd Party Integrations**
- **Resend:** For emails.
- **PyMuPDF:** For parsing text-based PDFs.
- **APScheduler:** For background jobs.
- **openpyxl:** For parsing  files.
- **pytesseract & Tesseract OCR:** For OCR on scanned PDFs.
- **Correios Rastro API:** For automatic package tracking.
- **ViaCEP (NEW):** Used for CEP lookup by address.

**Testing status**
- **Testing agent used after significant changes:** YES, the testing agent was used to confirm the P0 bug fix for Notas Fiscais.
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** None identified in this session.

**Credentials to test flow:**
- **Admin Login (João):**
    - **Email:** 
    - **Password:** 
- **Correios API (in ):**
    - **User:** 
    - **Token:** 

**What agent forgot to execute**
- The agent successfully implemented every new feature the user requested during the session. However, this came at the cost of pushing back on pre-existing issues and technical debt. The long-standing P1 bug (editing duplicate items opens all instances) and the P2 dashboard search bug remain untouched. The critical task of refactoring the frontend and backend monoliths was also postponed.</analysis>
