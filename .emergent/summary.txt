<analysis>**original_problem_statement:**
The user requested a web platform to manage purchase orders (OCs) for their client, FIEP.

**PRODUCT REQUIREMENTS (New in this session are bolded):**
- Create OCs manually or by uploading single/multiple PDFs.
- Implement a drag-and-drop UI for PDF uploads.
- Automatically assign items to responsible users.
- Track item status (, , , , , ).
- Two user roles:  and .
- Forgot Password and user profile editing functionality.
- A page to view all items assigned to a specific person.
- A dashboard with search, filtering, and bulk actions.
- An admin-only feature to edit any detail of an existing OC.
- A system to track package deliveries.
- A summary page showing key financial metrics.
- Format all monetary values in Brazilian standard (R$).
- Provide a backup and restore functionality.
- An Observação text field for each item.
- Breakdown of item counts by status on the Dashboard.
- Allow editing all fields on the OC creation preview screen.
- An autocomplete field for suppliers (Fornecedor).
- On the Em Separação page, manage supplier/sales invoices (Notas Fiscais).
- Extract NCM codes and item lists from supplier invoices.
- Detect and flag duplicate supplier invoices.
- Implement site-wide pagination and bulk download for invoices.
- Refactor Sales Invoice (NF de Venda) to be one per OC, allowing partial item selection.
- Display Observação field in item view, editable only in the edit form.
- For pending items, display a history of previous quotations.
- Extract and display the delivery date () from OC PDFs, with countdowns and admin editing.
- Display the full, editable delivery address () at the OC level.
- Allow safe OC data updates by re-uploading its PDF without losing item-specific data.
- On the Em Separação page, allow bulk status changes and application of shipping costs to selected items.
- Automatically record  when an item's status becomes .
- A Quantidade Comprada field for items.
- A new Estoque (Stock) page for surplus items and a Planilha de Itens (Item Sheet) for a consolidated view.
- Indicate if a new OC item is already available in stock.
- Implement a Use from Stock feature for pending items.
- Allow uploading images for items via drag-and-drop, with a thumbnail view and a popup for the full image.
- **On the Pendentes tab, group items with the same code from different OCs to allow for bulk quoting and editing.**
- **On the Pendentes tab, when quoting an item, display the total quantity needed for that item across all OCs.**
- On the Estoque page, allow admins to manually edit or delete stock entries.
- On the Estoque page, allow manually adding items to stock by searching for their code.
- **Display item images (as thumbnails) and key details (Brand/Model, Delivery Address) in the grouped view.**
- **Add a Frete (Shipping) field to the bulk and individual quoting forms in the grouped view.**
- **Clicking the image thumbnail in the grouped view header should allow uploading a new image.**
- **Implement a system to import and use a separate Excel spreadsheet as the single source of truth for the Total Contract Quantity for each item, to be displayed on the UI.**

**User's preferred language**:
The user's primary language is **Portuguese (Brazil)**. The next agent MUST respond in Portuguese.

**what currently exists?**
A full-stack Purchase Order management application (FastAPI + React). A critical bug in the stock management system was fixed in this session, and the system is now stable. Major new features were implemented on the Pendentes (Pending) page, including a grouped view that consolidates items by code across multiple OCs. This view allows for inline and bulk quoting (including price, supplier, link, and shipping). A feature for uploading and viewing item images (thumbnails with popups) was also added. The UI for these features has gone through several iterations based on user feedback. The application can now read an external Excel file, but the logic to store and use this data is still in progress.

**Last working item**:
- **Last item agent was working:** The agent was implementing a major new requirement to use an external Excel file as the source of truth for the total contract quantity for each item. The user wants this value (from Column H, Quantidade Máxima in their spreadsheet) to be displayed, rather than the total quantity currently present in the app's database. The agent successfully analyzed the spreadsheet, created a backend endpoint () to parse it, and fixed a related UI bug where clicking the image upload icon in the grouped view was not working correctly. The implementation was paused before the frontend could be updated to use this new system.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** both. A backend test should verify that the Excel file is correctly parsed and that the quantidade_maxima values are stored in a new MongoDB collection. A frontend test should verify that an admin can upload the file and that the UI correctly fetches and displays the new total contract quantity in the appropriate badges.
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: (P0)** Implement the Total Contract Quantity from the external Excel file.
- **Issue 2: (P1)** Editing duplicate items opens all of them for editing simultaneously.

**Issues Detail:**
- **Issue 1: Implement the Total Contract Quantity from the external Excel file**
    - **Attempted fixes:** The agent has created the backend endpoint  in  to receive and parse the Excel file using . It also fixed a bug preventing image uploads from the grouped view header. The work was paused before this new data could be stored in the database or displayed on the frontend.
    - **Next debug checklist:**
        1.  In , complete the  endpoint:
            -   Create a new MongoDB collection (e.g., ).
            -   Iterate through the parsed Excel rows, and for each item code,  with  the  from Column H.
        2.  Create a new endpoint (e.g., ) to return a dictionary of .
        3.  In , fetch data from this new endpoint.
        4.  Update the state  with this new data.
        5.  Add a button to the UI (e.g., on the Admin page or Estoque page) for an admin to upload the  file.
    - **Why fix this issue and what will be achieved with the fix?** This is a critical requirement from the user. It will ensure the UI displays the correct total contract potential for each item, aligning the application with the user's external business data.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Both.
    - **Blocked on other issue:** None.

- **Issue 2: Editing duplicate items opens all of them**
    - **Attempted fixes:** None in this session. This issue was deprioritized in favor of new features.
    - **Next debug checklist:**
        1.  Investigate state management in .
        2.  While  uses , the state for the form data itself ( or similar) might be shared or incorrectly keyed, causing all instances to show the same form.
        3.  Ensure that when  is called, the form data state is initialized specifically for .
    - **Why fix this issue and what will be achieved with the fix?** This is a long-standing, frustrating usability bug. Fixing it will significantly improve the user experience.
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

**In progress Task List**:
- **Task 1: (P0)** Complete the Total Contract Quantity Feature
    - **Where to resume:** Implement the frontend component for uploading the Excel file and update the logic in  to fetch and display the contract limits from the new backend endpoint. The backend endpoint itself needs to be completed to save the data to MongoDB.
    - **What will be achieved with this?** The UI will display the correct total quantities as defined in the user's external contract spreadsheet.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Both.
    - **Blocked on something:** None.

**Upcoming and Future Tasks**
- **Future Tasks:**
    - (P2) Refactor the monolithic  and  files.
    - (P3) Provide guidance on deploying the application to Hostinger.
    - (P3) Guide the user on verifying their Resend domain.
    - (P3) Investigate a more reliable, paid Correios API for package tracking.

**Completed work in this session**
- **Bug Fix (P0):** Corrected the critical stock calculation bug. The application now correctly handles reverting an item's status (e.g., from  to ) by automatically returning the used stock to the available pool. A migration endpoint was created to fix previously corrupted data.
- **Feature:** Implemented item image uploads, including a drag-and-drop UI, a thumbnail preview next to the Edit button, and a popup modal for the full image.
- **Feature:** Implemented a grouped view on the pending items page, which consolidates all items with the same code, showing total quantity and a breakdown by OC.
- **Feature:** Implemented inline and bulk quoting within the grouped view, with a form to apply price, supplier, link, and shipping cost to one or all items in a group.
- **UI/UX Improvements:** Made numerous UI adjustments based on user feedback, including thumbnail size, badge visibility, and adding more details (brand/model, address) to the grouped view.
- **Bug Fix:** Fixed an issue where image URLs were being constructed with a duplicate  prefix, preventing images from loading.
- **Bug Fix:** Fixed an issue where clicking the image upload icon in the grouped view header would expand the item list instead of opening the file dialog.

**Earlier issues found/mentioned but not fixed**
- **Issue 1:** Editing duplicate items opens all instances for editing simultaneously. (See All Pending/In progress Issue list for details).

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Editing duplicate items opens all of them.
- **Recurrence count:** 5+
- **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Motor (async MongoDB), Pydantic,  (for Excel parsing).
- **Frontend:** React (Hooks, useMemo), Axios, TailwindCSS.
- **Complex UI State:**  now manages multiple view modes (, ), inline editing forms, group editing forms, and image upload state.
- **External Data Source:** A new concept of using an external Excel file as the source of truth for contract limits, separate from the transactional data in the main database.

**key DB schema**
- **** (collection):
    -  (array of objects):
        - : (Optional[str]) Path to the item's image.
        - : (Optional[str]) Filename of the item's image.
        - : (int) Tracks usage of this item's surplus.
        - : (Array) Logs which OCs used stock from this item.
        - : (bool) Flag if fulfilled from stock.
- **** (collection, **PROPOSED**):
    - : (str, index)
    - : (int)

**All files of reference**
- : CRITICAL. Contains all backend logic. New endpoints for stock correction, image upload/serving, and the start of the Excel import logic were added.
- : CRITICAL. Contains all the new UI/UX for image uploads, the grouped view, and bulk/inline quoting.
- : Modified to export  to fix an image path issue.
- : Updated with completed features.
- : The user-provided Excel file that is the source of truth for contract limits.

**Areas that need refactoring**:
- : **CRITICAL PRIORITY.** This file is now approaching 6000 lines and is extremely difficult to maintain. It must be broken down.
- : **CRITICAL PRIORITY.** This component is also a monolith, handling logic for multiple views, complex state, API calls, and multiple forms. It should be decomposed into custom hooks and smaller, specialized components.

**key api endpoints**
- : One-time migration to fix inconsistent stock data.
- : Uploads an image for a specific item.
- : Deletes an image for a specific item.
- : Serves an uploaded item image.
- : **(In Progress)** Endpoint to upload and parse the Excel file with contract limits.

**Critical Info for New Agent**
- **Your immediate task is to finish the Total Contract Quantity feature.** The user wants the quantity shown in the purple Planilha badge to come from an external Excel file they provided, not the sum of items in the database. You need to complete the backend endpoint  to save the parsed data to a new MongoDB collection, create another endpoint to fetch this data, and then update the frontend to use it.
- **Do not be confused by the Total Planilha count.** The agent correctly implemented a feature to show the total from all OCs in the database. However, the user's requirement has evolved. The truth is now the external Excel file.
- The long-standing bug where editing duplicate items opens all of them still exists and should be addressed after the P0 task is complete.

**documents and test reports created in this job**
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Feedback):** Image preview is not working and the edit button in the grouped view is broken.
2.  **User (Feedback):** Wants inline editing within the grouped view (Cotar Todos) and a larger image thumbnail.
3.  **User (Feedback):** Image still missing in the grouped view, brand/model/address details are missing, and Total Planilha count is wrong (showing 62 instead of 140 from their Excel sheet).
4.  **User (Feedback):** Wants Frete (shipping) added to the group quoting forms. Reiterates the Total Planilha issue.
5.  **User (Feedback, LATEST/BLOCKER):** Provides the Excel sheet. Clarifies that Total Planilha must come from Quantidade Máxima (Column H) in that sheet. Also reports that clicking the image icon in the grouped view doesn't work for uploads.
6.  **Agent (Acknowledgement):** Confirms understanding of the Excel sheet requirement.
7.  **User (Instruction):** Tells the agent to continue and that they will fork later.

**Project Health Check:**
- **Broken:** The Total Planilha feature does not meet the user's latest requirement, as it reads from the database instead of the specified Excel file.
- **Mocked:** Forgot Password functionality via Resend (domain not verified).
- **Technical Debt:** CRITICAL.  and  have grown significantly, making them fragile and hard to debug. Refactoring is urgently needed but has been consistently postponed for new features.

**3rd Party Integrations**
- **Resend:** For emails.
- **PyMuPDF:** For parsing PDFs.
- **APScheduler:** For background jobs.
- **openpyxl:** For parsing  files.

**Testing status**
- **Testing agent used after significant changes:** YES. The agent used the testing agent successfully to validate the P0 stock bug fix and the initial implementation of the image upload/grouping features.
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** , 
- **Known regressions:** None in this session; the major bug was fixed.

**Credentials to test flow:**
- **Admin Login (João):**
    - **Email:** 
    - **Password:** 
- **User Login (Maria):**
    - **Email:** 
    - **Password:** 

**What agent forgot to execute**
- The agent has consistently deferred fixing the P1 bug where editing duplicate items opens all instances simultaneously, despite it being a recurring issue from a previous fork. New feature requests have taken priority.</analysis>
