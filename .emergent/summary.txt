<analysis>**original_problem_statement:**
The user requested a web platform to manage purchase orders (OCs) from their client, FIEP.

**PRODUCT REQUIREMENTS (New in this session are bolded):**
- Create OCs manually or by uploading single/multiple PDFs.
- Implement a drag-and-drop UI for PDF uploads.
- Automatically assign items to responsible users.
- Track item status (, , , , , ).
- Two user roles:  and .
- Forgot Password and user profile editing functionality.
- A page to view all items assigned to a specific person.
- A dashboard with search, filtering, and bulk actions.
- An admin-only feature to edit any detail of an existing OC.
- A system to track package deliveries.
- A summary page showing key financial metrics.
- Format all monetary values in Brazilian standard (R$).
- Provide a backup and restore functionality.
- On the Em Separação page, manage supplier/sales invoices (Notas Fiscais).
- An Observação text field for each item.
- Breakdown of item counts by status on the Dashboard.
- Fix PDF parsing for items with CT (cento) as a unit.
- Allow editing all fields on the OC creation preview screen.
- Implement an autocomplete field for suppliers (Fornecedor).
- Extract NCM codes and item lists from supplier invoices.
- Detect and flag duplicate supplier invoices.
- Implement site-wide pagination.
- Implement a bulk download feature for supplier invoices.
- Refactor the Sales Invoice (NF de Venda) to be one per OC.
- **Allow selecting specific items from an OC to be included in a partial Sales Invoice.**
- **The Observação field should be visible in the item view but only editable within the item's edit form.**
- **For pending items, display a history of previous quotations (supplier, price, link) if the item was quoted before.**
- **Extract the delivery date () from OC PDFs.**
- **Display the delivery date next to the OC number everywhere, with a countdown (e.g., 10 dias restantes) or an overdue warning (e.g., ⚠️ 5 dias em atraso).**
- **Allow admins to manually edit the delivery date for existing OCs.**
- **Display the delivery address () in the header alongside the OC number.**
- **On the Em Separação page, display the progress of supplier invoice uploads (e.g., NF Fornecedor: 3 de 5 itens).**
- **On the Em Separação page, sort OCs by readiness: 1) OCs with both supplier and sales invoices, 2) OCs with only supplier invoices, 3) OCs with no invoices.**
- **Ensure all status dropdowns across the application show all six available statuses.**

**User's preferred language**:
The user's primary language is **Portuguese (Brazil)**. The next agent MUST respond in Portuguese.

**what currently exists?**
A full-stack Purchase Order management application. The previous session addressed several user requests, enhancing functionality around partial invoicing, data visibility, and workflow optimization. The application is stable.

Key functionalities implemented in this session:
- **Partial Invoicing:** Users can now select specific items within an OC and generate a Sales Invoice (NF de Venda) just for them. The system supports multiple partial invoices per OC.
- **Delivery Date Tracking:** The delivery date is extracted from new PDFs and can be manually set for old OCs. This date is displayed across the app (Dashboard, Item Lists, OC Details) with a dynamic badge showing a countdown or overdue status. The badge correctly shows Delivered instead of Overdue for completed items.
- **Historical Quotes:** On the Pendente items page, users can click a button to see a history of previous quotes for that same item, including supplier, price, and a direct link to the product.
- **Observação Field:** The Observação field is now read-only in the main item view and is only editable inside the item's edit form, as requested.
- **Deployment Readiness:** Critical deployment blockers were resolved by fixing the  file and adding necessary MongoDB indexes to optimize performance.
- **UI/UX Enhancements:**
    - The Em Separação page now shows progress for supplier invoices and sorts OCs by their readiness for dispatch.
    - All status dropdowns throughout the app have been standardized to include all six statuses.
    - The delivery date editor was improved with a dedicated save button to prevent accidental updates.

**Last working item**:
- **Last item agent was working:** Implementing the user's request to display the delivery address () in the header of every OC view, alongside the delivery date.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** Frontend testing agent. The agent must verify:
    1.  The delivery address appears next to the OC number on the .
    2.  The delivery address appears in the item header on the  page (for all statuses).
    3.  The delivery address appears in the OC header in the Em Separação grouped view.
    4.  The delivery address appears in the header on the  page.
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: (P0)** Complete the implementation of displaying the delivery address everywhere an OC is shown.
- **Issue 2: (P2)** Editing duplicate items opens all of them for editing simultaneously. This is a recurring usability bug from a previous session that has not been addressed.

**Issues Detail:**
- **Issue 1: Complete displaying delivery address**
    - **Attempted fixes:** The agent has started modifying  and  to include the delivery address in the UI. Backend endpoints were also updated.
    - **Next debug checklist:**
        1.  Finalize UI changes in , particularly in the grouped OC view ().
        2.  Verify the address is also shown on the . The agent added the field to the table but did not visually confirm.
        3.  Build the frontend (yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.) and restart services.
        4.  Take screenshots of the Dashboard, ItemsByStatus page (e.g., 'Pendente'), and the 'Em Separação' view to confirm the address appears correctly everywhere.
    - **Why fix this issue and what will be achieved with the fix?** Fulfills a direct user request for better data visibility at a glance.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

- **Issue 2: Editing duplicate items opens all of them**
    - **Attempted fixes:** None in this session. A fix was supposedly applied in a past session but the issue persists.
    - **Next debug checklist:**
        1.  After fixing Issue 1, investigate the state management in .
        2.  The  state is likely being set to a non-unique identifier (like ).
        3.  The fix is to ensure the  state uses a truly unique ID for each item instance, which seems to be . The agent was already using this for some parts, but it needs to be consistently applied to the edit toggle logic.
    - **Why fix this issue and what will be achieved with the fix?** This is a long-standing, disruptive usability bug that frustrates the user.
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None.

**In progress Task List**:
- **Task 1: Finish implementing delivery address display**
    - **Where to resume:** The file . The agent has already updated the  function and the individual item view. The next steps are to update the grouped OC view, test thoroughly across the app, and ensure consistency.
    - **What will be achieved with this?** The delivery address for each OC will be clearly visible on the Dashboard, item lists, and OC detail pages, improving logistical clarity.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on something:** None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1)** Fix the recurring bug where editing duplicate items opens all of them.
-   **Future Tasks:**
    -   **(P2)** Refactor the monolithic  and  files.
    -   **(P3)** Provide guidance on deploying the application to Hostinger.
    -   **(P3)** Guide the user on verifying their Resend domain for Forgot Password emails.
    -   **(P3)** Investigate a more reliable, paid Correios API for package tracking.

**Completed work in this session**
- **Feature:** Implemented partial Sales Invoices (NF de Venda) with item selection and backend support for multiple NFs per OC.
- **Feature:** Implemented a historical quotation lookup for pending items, showing previous supplier prices and links.
- **Feature:** Added delivery date extraction from PDFs and display across the app with countdown/overdue badges.
- **Feature:** Implemented a feature for admins to manually edit the delivery date of existing OCs.
- **Feature:** Enhanced the Em Separação view to show supplier invoice progress and sort OCs by readiness.
- **Bug Fix:** The Observação field is now correctly displayed as read-only in the item view and is editable only within the edit form.
- **Bug Fix:** Corrected a visual glitch where  appeared on the UI.
- **Bug Fix:** Ensured that delivered items show a Delivered status instead of an Overdue warning.
- **Bug Fix:** Fixed the Dashboard to correctly display the delivery date column.
- **Bug Fix:** Standardized all status dropdowns to include every available status.
- **UX Improvement:** Added a dedicated Save button for editing the delivery date to prevent accidental changes.
- **Technical Debt:** Resolved critical deployment blockers by correcting the  file and creating necessary MongoDB indexes.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Editing duplicate items opens all of them.
- **Recurrence count:** 3+
- **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, Motor (async MongoDB), Pydantic.
- **Frontend:** React (Hooks, Context, useMemo), Axios, TailwindCSS.
- **PDF Parsing:**  and regex to extract structured data, now including delivery dates from item tables.
- **Date Manipulation:** Using  in Python and  object in JavaScript to calculate countdowns and overdue statuses.
- **State Management:** Complex state management in React for handling selections (), toggles (), and local edits ().
- **Dynamic Sorting:** Using  within a  hook in React to reorder OCs based on multiple criteria (NF status).
- **Database Indexing:** Added indexes on startup in  to improve query performance.

**key DB schema**
-   ****:
    -    (string, format ): New field added to store the delivery date.
    -    (list of objects): Changed from a single object to a list to support multiple partial invoices. Each object contains .
-   ****:
    - ,  fields for password reset.
-   ****:
    - For storing active user sessions.

**All files of reference**
-   : Heavily modified. New endpoint  for historical quotes,  for date updates. PDF parsing logic updated to extract delivery dates. Endpoints for creating and listing OCs updated to handle .
-   : **The most heavily modified file.** Contains logic for partial NF selection, historical quote display, delivery date badges, supplier NF progress, and OC sorting. This is where the current work is focused.
-   : Modified to add and display the DATA ENTREGA column.
-   : Modified with a new component to allow editing the  of an OC.
-   : Modified to add the delivery date badge and standardize the status dropdown.
-   : Updated  and  models to include the optional  field.

**Areas that need refactoring**:
-   : **CRITICAL PRIORITY.** This file is now well over 4000 lines and is extremely difficult to maintain.
-   : **CRITICAL PRIORITY.** This god component has absorbed even more logic. The new  component and sorting logic should be extracted.

**key api endpoints**
-   **New Endpoints:**
    -   : Takes  and returns a history of previous quotes.
    -   : Takes  and updates the delivery date for a specific OC.
-   **Modified Endpoints:**
    -   : Now accepts an optional  in the body to create a partial invoice.
    -   : Now requires the  to delete a specific partial invoice.
    -   , , : All updated to handle the  field.
    -   : The response objects now include the  field.

**Critical Info for New Agent**
-   Your immediate priority is to complete the user's request to display the  in all OC headers. This work is already in progress in .
-   After completing the current task, the highest priority should be fixing the long-standing bug where editing duplicate items opens all of them simultaneously.
-   The user is highly responsive and provides clear feedback. Pay close attention to their screenshots.
-   The monolithic files (, ) are a significant source of technical debt. Propose refactoring them after the immediate user requests are fulfilled.

**documents and test reports created in this job**
- /app/memory/PRD.md: Updated with all the newly completed features.

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request:** Implement a historical quotation feature for pending items. (Completed)
2.  **Feedback:** The historical quote feature is good, but needs to show the purchase link and handle multiple quotes for the same item. (Completed)
3.  **Request:** Extract and display the delivery date for OCs, showing a countdown and an overdue status. (Completed)
4.  **Feedback:** How can I add dates to old OCs? (Agent implemented a manual edit feature).
5.  **Feedback/Bugs:**
    1. Delivered items still show as overdue.
    2. The Dashboard doesn't show the delivery date.
    3. The date editor saves on every click, which is bad UX. (All three fixed).
6.  **Request:**
    1. Show the status of supplier invoice uploads (e.g., 3 of 5 items have NF).
    2. Sort OCs in Em Separação by readiness for dispatch. (Completed).
7.  **Request:** Ensure all status dropdowns in the app contain all 6 possible statuses. (Completed).
8.  **Request (LATEST/IN-PROGRESS):** Display the delivery address next to the OC number and delivery date in all views.
9.  **Pending Clarification:** None. The latest user request is clear.

**Project Health Check:**
-   **Broken:** NO
-   **Mocked:** Forgot Password functionality via Resend (domain not verified).
-   **Technical Debt:** CRITICAL. The  and  files are fragile and hard to maintain.

**3rd Party Integrations**
-   **Resend:** For emails.
-   **PyMuPDF:** For parsing PDFs.
-   **SeuRastreio API:** For package tracking (inactive).
-   **APScheduler:** For background jobs.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** None. The agent successfully implemented several features and fixed bugs without introducing new regressions.

**Credentials to test flow:**
-   **Admin Login (João):**
    -   **Email:** 
    -   **Password:** 
-   **User Login (Maria):**
    -   **Email:** 
    -   **Password:** 

**What agent forgot to execute**
- The agent has not addressed the recurring bug where editing an item that appears multiple times on a page (e.g., same ) causes all instances to open for editing simultaneously. This was noted in the initial handoff and remains a pending issue.</analysis>
