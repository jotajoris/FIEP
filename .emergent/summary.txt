<analysis>**original_problem_statement:**
The user requested a web platform to manage purchase orders (OCs) for their client, FIEP.

**PRODUCT REQUIREMENTS (New in this session are bolded):**
- Create OCs manually or by uploading single/multiple PDFs.
- Implement a drag-and-drop UI for PDF uploads.
- Automatically assign items to responsible users.
- Track item status (, , , , , ).
- Two user roles:  and .
- Forgot Password and user profile editing functionality.
- A page to view all items assigned to a specific person.
- A dashboard with search, filtering, and bulk actions.
- An admin-only feature to edit any detail of an existing OC.
- A system to track package deliveries.
- A summary page showing key financial metrics.
- Format all monetary values in Brazilian standard (R$).
- Provide a backup and restore functionality.
- On the Em Separação page, manage supplier/sales invoices (Notas Fiscais).
- An Observação text field for each item.
- Breakdown of item counts by status on the Dashboard.
- Fix PDF parsing for items with CT (cento) as a unit.
- Allow editing all fields on the OC creation preview screen.
- Implement an autocomplete field for suppliers (Fornecedor).
- Extract NCM codes and item lists from supplier invoices.
- Detect and flag duplicate supplier invoices.
- Implement site-wide pagination.
- Implement a bulk download feature for supplier invoices.
- Refactor the Sales Invoice (NF de Venda) to be one per OC.
- Allow selecting specific items from an OC to be included in a partial Sales Invoice.
- The Observação field should be visible in the item view but only editable within the item's edit form.
- For pending items, display a history of previous quotations (supplier, price, link) if the item was quoted before.
- Extract the delivery date () from OC PDFs.
- Display the delivery date next to the OC number everywhere, with a countdown or an overdue warning.
- Allow admins to manually edit the delivery date for existing OCs.
- **Display the delivery address () in the header alongside the OC number, and ensure this data is at the OC level, not the item level.**
- **Allow admins to edit the OC's delivery address directly from the UI.**
- **Allow the full delivery address to be visible on the Dashboard without being truncated.**
- **Implement a safe way to update an existing OC's data (like address and delivery date) by re-uploading its PDF, without losing item-specific data like status, notes, or assigned user.**
- **On the Em Separação page, allow selecting specific items to apply a total shipping cost (), which is then divided equally among them.**
- **On the Em Separação page, allow selecting specific items to change their status in bulk.**
- **Automatically record the  (purchase date) when an item's status changes to  or a later stage. The date should be removed if the status reverts to  or .**
- **Add a Quantidade Comprada field to items.**
- **Create a new Estoque (Stock) page to show items where the quantity purchased exceeds the quantity needed.**
- **Create a new Planilha de Itens (Item Sheet) page to provide a consolidated view of all items across all OCs, grouped by item code, to track overall purchasing progress.**
- **When a new OC item appears, the system should indicate if that item is already available in stock.**

**User's preferred language**:
The user's primary language is **Portuguese (Brazil)**. The next agent MUST respond in Portuguese.

**what currently exists?**
A full-stack Purchase Order management application built with FastAPI and React. The last session added significant new features based on user requests, including:
-   **Universal Delivery Address Display:** The delivery address is now shown on the Dashboard, OC details page, and item lists. A data migration moved addresses from the item level to the OC level for consistency. Admins can edit this address directly.
-   **OC Update from PDF:** A safe update mechanism was created. Users can re-upload an OC's PDF (individually or in bulk via the Admin Panel) to refresh data like delivery address and date without losing existing item statuses, notes, or assignments.
-   **Bulk Actions in Em Separação:**
    -   Users can now select multiple items within an OC to apply a shared shipping cost ().
    -   Users can select multiple items to change their status in a single action.
-   **Automatic Purchase Date:** The system now automatically records and displays the date an item was purchased when its status is updated to  or beyond.
-   **Stock & Inventory Management (Initial Implementation):**
    -   A new Estoque (Stock) page was created to track surplus items.
    -   A new Planilha de Itens (Item Sheet) page was added to give a consolidated view of all items needed across all OCs.
    -   An item field for Quantidade Comprada was added to the edit form.

**Last working item**:
- **Last item agent was working:** Addressing a multi-part bug report from the user regarding the newly implemented stock management feature. The user reported that (1) stock was not being updated correctly, (2) the profit calculation was wrong for items with surplus purchases, and (3) the UI didn't show available stock for new pending items.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** Backend testing agent. The core issues are in the backend logic: the  aggregation pipeline, the profit calculation within the item update endpoints, and the data returned for pending items.
- **User Testing Done:** Y

**All Pending/In progress Issue list**:
-   **Issue 1: (P0)** Fix the Stock and Profit Calculation Bugs.
-   **Issue 2: (P1)** Editing duplicate items opens all of them for editing simultaneously.

**Issues Detail:**
-   **Issue 1: Fix Stock and Profit Calculation Bugs**
    -   **Attempted fixes:** The agent modified the backend logic to consider the quantity from  for the stock calculation, but this was not sufficient and the user reported the stock was still zero.
    -   **Next debug checklist:**
        1.  **Stock is Zero:** Investigate the  endpoint in . The logic likely isn't correctly calculating the surplus or is filtering by the wrong item status. The calculation must be: . The  is the greater of  or the sum of quantities in . This logic should only apply to items in statuses  or later.
        2.  **Incorrect Profit Calculation:** Find the profit () calculation in  (likely within item update functions). It's probably using the total purchased quantity for its calculation. It must be changed to use the item's required quantity () instead.
        3.  **Display Available Stock:** This is a feature request tied to the bug. Modify the endpoint that loads items for the  page to also query the new stock collection/logic and attach the available stock count to any item being displayed. Then, in , add a UI element (e.g., a badge) to the item card to show X em estoque if the item status is  or .
    -   **Why fix this issue and what will be achieved with the fix?** The new stock management feature is unusable until these bugs are fixed. Fixing them will make the feature functional and fulfill the user's core requirement.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Both. Backend for logic, frontend for display.
    -   **Blocked on other issue:** None.

-   **Issue 2: Editing duplicate items opens all of them**
    -   **Attempted fixes:** None in this session. This is a known recurring issue.
    -   **Next debug checklist:**
        1.  Investigate the  state management in .
        2.  The state is likely being set using a non-unique identifier like .
        3.  Refactor the logic to consistently use the unique  when setting the  state to ensure only the specific item instance is opened for editing.
    -   **Why fix this issue and what will be achieved with the fix?** This is a long-standing, frustrating usability bug. Fixing it will significantly improve the user experience.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend.
    -   **Blocked on other issue:** None.

**In progress Task List**:
None. The current focus is on bug fixing.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1)** Implement the UI to display available stock on pending/quoted items, once the backend bug is fixed.
-   **Future Tasks:**
    -   **(P2)** Refactor the monolithic  and  files.
    -   **(P3)** Provide guidance on deploying the application to Hostinger.
    -   **(P3)** Guide the user on verifying their Resend domain for Forgot Password emails.
    -   **(P3)** Investigate a more reliable, paid Correios API for package tracking.

**Completed work in this session**
-   **Feature:** Implemented universal display of the OC delivery address and migrated all existing data to the OC level.
-   **Feature:** Created an admin feature to edit the delivery address directly on the OC details page.
-   **Feature:** Implemented a safe Update from PDF feature (single and bulk) to refresh OC data without losing item progress.
-   **Feature:** Implemented bulk actions on the Em Separação page to apply shipping costs or change status for selected items.
-   **Feature:** Implemented automatic recording and display of an item's purchase date.
-   **Feature:** Created the foundational backend and frontend for new Estoque (Stock) and Planilha de Itens (Item Sheet) pages.
-   **Bug Fix:** Modified the Dashboard to display full, non-truncated addresses.
-   **Bug Fix:** Fixed a frontend rendering issue in  caused by an unclosed .

**Earlier issues found/mentioned but not fixed**
-   **Issue 1:** Editing duplicate items opens all instances for editing simultaneously.
    -   **Debug checklist:** The  state in  must use a unique item identifier () instead of a shared one ().
    -   **Why to solve this issue and what will be achieved with this?** This is a disruptive usability bug that has been reported multiple times. Fixing it will improve the core user workflow.
    -   **Should Test frontend/backend/both after fix:** Frontend.
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Editing duplicate items opens all of them.
-   **Recurrence count:** 3+
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Motor (async MongoDB), Pydantic.
-   **Frontend:** React (Hooks, Context), Axios, TailwindCSS.
-   **Data Migration:** A one-time API endpoint was created to migrate data ().
-   **MongoDB Aggregation Pipelines:** Complex pipelines were used to create the  and  endpoints.
-   **Complex State Management:** Heavy use of React state in  to manage multiple simultaneous selections for different bulk actions (NF-e, Freight, Status).

**key DB schema**
-   **** (collection):
    -   : (string) Field added at the top level.
    -    (array of objects):
        -   : (Optional[string]) New field for purchase date.
        -   : (Optional[int]) New field for total quantity purchased.

**All files of reference**
-   : CRITICALLY modified. Contains all new endpoints for data migration, address editing, PDF updates, bulk actions (freight, status), and the new inventory pages (stock, sheet). Also contains all the logic for automatic purchase dates and the currently buggy stock/profit calculations.
-   : CRITICALLY modified. Contains all the UI and state logic for the three new bulk selection actions (NF, Freight, Status), the new Quantidade Comprada field in the edit form, and the display of the new .
-   : Modified to display the OC address correctly and add the Update with PDF and address editing features.
-   : Modified to add the bulk Update with PDF feature.
-   : Modified to display the full delivery address.
-   : New file for displaying stock.
-   : New file for the consolidated item view.
-    & : Modified to add routes and navigation links for the new pages.
-   : Updated , , and other schemas to include the new fields.

**Areas that need refactoring**:
-   : **CRITICAL PRIORITY.** Now approaching 5000 lines, this file is unsustainable. It needs to be broken down into routers by domain (e.g., , , ).
-   : **CRITICAL PRIORITY.** This component is now responsible for displaying items, editing items, and managing three separate bulk action selection states. Its logic needs to be broken down into custom hooks and smaller, more focused components.

**key api endpoints**
-   : One-time script to migrate addresses.
-   : Updates the delivery address for a single OC.
-   : Updates an OC's data from a re-uploaded PDF.
-   : Applies a shared shipping cost to selected items.
-   : Changes the status of selected items.
-   : Returns surplus items for the stock page. (BUGGY)
-   : Returns a consolidated view of all items.

**Critical Info for New Agent**
-   Your immediate priority is to fix the three interconnected issues from the user's last message: the stock count being zero, the profit calculation being incorrect, and the lack of available stock information on new items. The user is blocked on using the new inventory feature.
-   Start by debugging the  endpoint in . The logic is flawed.
-   After fixing the bugs, address the long-standing issue of duplicate items opening for editing simultaneously. This has been requested multiple times and is a major source of user frustration.
-   The user is highly engaged and provides quick, specific feedback. Expect to iterate rapidly.

**documents and test reports created in this job**
- /app/memory/PRD.md: Updated multiple times with newly completed features.

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request:** Add a bulk status change feature for ALL items in an OC.
2.  **Clarification:** Don't change all items, let me SELECT which items to change the status for. (Completed)
3.  **Request:** Automatically add a purchase date when an item becomes Comprado and display it. (Completed)
4.  **Request:** Major feature - Implement a stock system. Add quantity purchased, a Stock page for surplus, and a Planilha page for a consolidated view. (Initial version completed)
5.  **Bug Report:** Tested the stock feature by buying 20 units of an item that needed 1, but the stock page is empty.
6.  **Agent Fix Attempt:** Agent adjusts backend logic to check .
7.  **Bug Report (LATEST/BLOCKER):** User reports three issues: (1) Stock is still zero after the fix. (2) Profit is calculated on all 20 purchased units, not the 1 required unit. (3) The system should show me if an item is available in stock when a new OC for it appears.
8.  **Pending User Response:** None. The agent was in the process of debugging when the session ended.

**Project Health Check:**
-   **Broken:** The new Stock Management feature is functionally broken due to bugs in the backend logic.
-   **Mocked:** Forgot Password functionality via Resend (domain not verified).
-   **Technical Debt:** CRITICAL.  and  have grown significantly more complex and are very difficult to maintain.

**3rd Party Integrations**
-   **Resend:** For emails.
-   **PyMuPDF:** For parsing PDFs.
-   **SeuRastreio API:** For package tracking (inactive).
-   **APScheduler:** For background jobs.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** The new stock feature has critical bugs preventing its use.

**Credentials to test flow:**
-   **Admin Login (João):**
    -   **Email:** 
    -   **Password:** 
-   **User Login (Maria):**
    -   **Email:** 
    -   **Password:** 

**What agent forgot to execute**
-   The agent did not address the recurring bug where editing an item that appears multiple times on a page causes all instances to open for editing simultaneously. This was noted in the initial handoff summary and ignored throughout the session.</analysis>
