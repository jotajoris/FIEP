<analysis>**original_problem_statement:**
The user requested a web platform to manage purchase orders (OCs) for their client, FIEP.

**PRODUCT REQUIREMENTS (New in this session are bolded):**
- Create OCs manually or by uploading single/multiple PDFs.
- Implement a drag-and-drop UI for PDF uploads.
- Automatically assign items to responsible users.
- Track item status (, , , , , , ).
- User roles: , , and ** (new)**.
- Forgot Password and user profile editing functionality.
- A page to view all items assigned to a specific person.
- A dashboard with search, filtering, and bulk actions.
- An admin-only feature to edit any detail of an existing OC.
- A system to track package deliveries with automatic status updates via Correios API.
- A summary page showing key financial metrics.
- Format all monetary values in Brazilian standard (R$).
- An Observação text field for each item.
- On the Em Separação page, manage supplier/sales invoices (Notas Fiscais).
- Extract data from supplier invoices (NCM codes, item lists) and flag duplicates.
- Implement site-wide pagination and bulk download for invoices.
- On the Pendentes and Cotados pages, group items with the same code for bulk actions.
- A stock management system to track available items, with manual entry and Use from Stock features.
- Link uploaded item images to the item's code.
- Implement partial purchase and partial shipment features.
- On the Pronto para Envio page, allow multiple sales invoice (PDF/XML) uploads at once.
- Extract requisitante (requestor) from OC PDFs and display it in the Dados Adicionais da NF section on all relevant status pages (, , , ).
- **Correct the profit calculation:** Lucro Realizado should only count  and  items. All other statuses contribute to Lucro Previsto.
- **Add a field for monthly Correios shipping costs** on the summary page to be factored into profit calculations.
- **Implement a new moderador user role:** This role can see everything an  sees, except for the Resumo Completo page and the Comissões section in the Admin Panel.
- **Create a new admin-only Lucro Total spreadsheet-style summary:**
    - Columns: Código, OC, Qtd Total, Qtd Entregue, Valor Compra, Valor Venda, Imposto (%), Frete Compra, Frete Venda, Custos Diversos, Lucro.
    - The  percentage must be editable and linked to the main summary page.
    - Must allow adding/managing Custos Diversos (e.g., packaging, parking).
    - A summary row at the top for delivered items.
    - A Pago/Não Pago status toggle for admins.

**User's preferred language**:
The user's primary language is **Portuguese (Brazil)**. The next agent MUST respond in Portuguese.

**what currently exists?**
A full-stack Purchase Order management application. In this session, the agent successfully completed the major refactoring of the stock management system, which was left in a broken state in the previous session. The system now uses a dedicated  collection, and all obsolete code related to the old ESTOQUE-MANUAL virtual OC has been removed and tested.

The agent also resolved several user-reported issues, including:
- **Requisitante Display:** Fixed bugs preventing the requisitante (requestor) from being displayed. It is now visible and editable in the Dados Adicionais da NF section on the Em Separação, Pronto para Envio, Em Trânsito, and Entregues pages. An admin endpoint was created to re-extract this data from all existing PDFs.
- **Stock Management Bugs:** Fixed Method Not Allowed errors when adding or editing stock items. The system now correctly handles adjustments for both manually added items and surplus items from OCs.
- **Admin Reports:** Implemented a new Relatório tab in the Admin Panel, which allows downloading a comprehensive Excel report on all OCs and their items, including a sheet for overdue items.

The agent has just begun scaffolding the three new major features requested by the user (profit calculation, moderator role, and total profit summary).

**Last working item**:
- **Last item agent was working:** Scaffolding the three new major feature requests from the user.
    1.  **Profit Calculation & Monthly Freight:** Began modifying  and creating backend endpoints in  to handle a configurable tax percentage and monthly shipping costs.
    2.  **Moderator Role:** Created a new  dependency in  to be used for authorization.
    3.  **Total Profit Sheet:** Started creating a new  component in  and backend endpoints (, ) to manage miscellaneous costs.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** both
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1: (P0)** Complete the three new user implementations (Profit Calculation, Moderator Role, Total Profit Sheet).
- **Issue 2: (P1)** Intermittent Production CORS errors.
- **Issue 3: (P2)** Editing an item that exists in multiple OCs opens all instances for editing instead of just one.

**Issues Detail:**
- **Issue 1: Complete the three new user implementations**
    - **Attempted fixes:** The agent has created the basic backend endpoints (, ), a new auth dependency (), and started modifying the frontend components (, ). The work is in the initial scaffolding stage.
    - **Next debug checklist:**
        1.  **Moderator Role:** Apply the  dependency to all relevant endpoints. Update the frontend (, , ) to hide sections based on the user's role.
        2.  **Profit Calculation:** In , correct the  function to calculate Lucro Realizado using only  and  statuses. Wire the new configuration UI to the  backend endpoints to save and load monthly freight and tax percentage.
        3.  **Total Profit Sheet:** Fully implement the  component in . Create the backend logic to fetch all necessary data, including from the new  collection, and present it in the requested spreadsheet format. Implement the add cost and mark as paid functionalities.
    - **Why fix this issue and what will be achieved with the fix?** Fulfills the user's latest and most critical business requirements for financial oversight and user permission control.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Both.
    - **Blocked on other issue:** None

- **Issue 2: Intermittent Production CORS errors**
    - **Attempted fixes:** The agent added a global middleware to  to forcibly add CORS headers to *every* response, including errors. This is a robust attempt to solve the issue.
    - **Next debug checklist:** This fix requires user deployment to production to be verified. The agent should inform the user that a potential fix has been deployed and ask for monitoring.
    - **Why fix this issue and what will be achieved with the fix?** This is a critical blocker that makes the production application unreliable.
    - **Status:** USER VERIFICATION PENDING
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Backend (verified in preview, needs production confirmation).
    - **Blocked on other issue:** None

- **Issue 3: Editing an item that exists in multiple OCs opens all instances**
    - **Attempted fixes:** None in this session.
    - **Next debug checklist:** In  (and other relevant pages), the modal trigger for editing likely uses a non-unique key like . This needs to be changed to use the item's unique MongoDB , which must be passed from the backend and used to identify the specific item instance to edit.
    - **Why fix this issue and what will be achieved with the fix?** Fixes a long-standing and confusing UI bug.
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** Frontend.
    - **Blocked on other issue:** None

**In progress Task List**:
- **Task 1: Complete the 3 new feature implementations**
    - **Where to resume:** The backend endpoints and auth functions exist, and frontend components have been created or modified. Resume by implementing the core logic for each feature as outlined in Issue 1 above.
    - **What will be achieved with this?** A new moderator role, corrected profit calculations, and a comprehensive admin-only profit/loss summary page.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** Both.
    - **Blocked on something:** None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - (P3) Implement Correios API for shipping price calculation (Preços e Prazos).
    - (P3) Add functionality to download an Excel report from the Estoque page.
- **Future Tasks:**
    - (P3) Add a Create OC button directly on the Planilha de Contrato page.

**Completed work in this session**
- **Stock System Refactor (COMPLETED):** Finished the full refactor of the stock management system to use a dedicated  collection. Removed all obsolete code from , migrated old data, and tested the new endpoints, resolving the primary blocker from the last session.
- **Requisitante Feature (COMPLETED):** Implemented UI to display the requisitante on all relevant status pages (, , , ). Added a manual edit feature and an admin tool to reprocess all existing PDFs to extract this data automatically.
- **Admin Reporting (COMPLETED):** Created a new Relatório tab in the Admin Panel with a feature to download a comprehensive Excel report detailing all items, OC summaries, and overdue items.
- **Stock Management Bug Fixes (COMPLETED):** Fixed errors preventing users from adding new items to stock or adjusting quantities of existing items. The system now correctly handles both manually added items and surplus items from OCs.
- **CORS Hardening (COMPLETED):** Implemented a global middleware to enforce CORS headers on all responses, aiming to resolve intermittent production errors.

**Earlier issues found/mentioned but not fixed**
- **Issue 1:** (P2) Editing an item that exists in multiple OCs opens all instances for editing instead of just the selected one. This long-standing recurring issue remains unresolved.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Editing duplicate items opens all of them.
- **Recurrence count:** 10+
- **Status:** NOT STARTED.

**Code Architecture**


**Key Technical Concepts**
- **Full-Stack Feature Implementation:** Scaffolding features across the stack by creating FastAPI endpoints, authentication dependencies, and corresponding React components.
- **Database Schema Extension:** Introducing new MongoDB collections (, ) to support new features.
- **Role-Based Access Control (RBAC):** Creating new authorization logic () to implement a  role.
- **Dynamic Excel Generation:** Using  on the backend to create complex, multi-sheet reports from database data.
- **Refactoring & Code Consolidation:** Successfully removing duplicated and obsolete code from  to complete the stock system refactor.

**key DB schema**
- ** (NEW):** A new collection to store global settings. Expected document: .
- ** (NEW):** A new collection for miscellaneous expenses. Expected fields: .
- **:** The schema is unchanged, but application logic will now interpret a  field value of .

**All files of reference**
- : Core backend file. Contains the new endpoints for reports, configurations, and costs, as well as the CORS middleware fix.
- : Contains the new  function, which is critical for the new user role.
- : Contains the completed UI for displaying the requisitante across multiple pages.
- : The entry point for the new admin reports and the planned Lucro Total page.
- : The page where profit calculations need to be corrected and the new config UI (freight/tax) needs to be wired up.
- : Contains the fixed logic for stock adjustments.

**Areas that need refactoring**:
-  and  are very large and would benefit from being broken down into smaller, more manageable modules/components.
- The new  in  should be implemented as a self-contained component to keep  from growing too large.

**key api endpoints**
- **NEW (Implemented):**
  - : Re-parses all saved OC PDFs to extract requestor data.
  - : Downloads the comprehensive Excel report.
- **NEW (Scaffolded):**
  - , : For managing global settings like tax and shipping.
  - , , : For managing miscellaneous costs.
- **FIXED / MODIFIED:**
  - : New endpoint to correctly adjust stock quantities.
  - : Old endpoint, now works alongside the new one.
  - All endpoints related to viewing items by status, which now include  data.

**Critical Info for New Agent**
- **Your immediate priority is to complete the three new features requested by the user.** The groundwork (backend endpoints, auth functions, basic UI components) has been laid, but the core logic for each is missing. You must now build out these features.
- **Moderator Role Implementation:** You need to apply the new  dependency to the appropriate backend endpoints and add conditional rendering logic to the frontend to hide sensitive information (like the  page and  panel) from users with the  role.
- **Profit Calculation Logic:** The user was very specific. You must modify  to ensure Lucro Realizado is calculated *only* from items with  or  status. The rest go to Lucro Previsto.
- **Total Profit Page:** This is a major new feature. Build the  component in  to fetch data from multiple endpoints (, , ) and display it in the requested spreadsheet-like format. Ensure admins can add new costs and change the tax percentage dynamically.

**documents and test reports created in this job**
- None in this session.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Requested fix for  not showing automatically for OC 3100069 and provided the PDF. (COMPLETED - Agent fixed the frontend data flow and created an endpoint to reprocess PDFs).
2.  **User:** Requested the  field to appear on , , and  pages, and to see which files have been uploaded. (COMPLETED - Agent added the UI to all requested pages and confirmed file lists are already shown).
3.  **User:** Requested a new admin report to see the status of all OCs and items to avoid penalties. (COMPLETED - Agent created a new Relatório tab in the Admin Panel with a comprehensive Excel download).
4.  **User:** Reported not being able to add or edit stock items, with a Method Not Allowed error. (COMPLETED - Agent identified a missing endpoint, created it, and fixed the logic to handle different stock item origins).
5.  **User:** Reported that many specific items could not be added to stock, showing an Item não encontrado no estoque manual error. (COMPLETED - Agent fixed the backend logic to correctly handle items that are surpluses from OCs vs. purely manual entries).
6.  **User:** Initiated the current set of tasks with three major implementation requests. (IN PROGRESS - This is the current ).

**Project Health Check:**
- **Stable:** The application is in a good state. The critical stock management refactor is complete and tested. The new work is being built on this stable foundation.
- **Technical Debt:**
  -  and  remain monolithic and are candidates for future refactoring to improve maintainability.

**3rd Party Integrations**
- **Resend:** For emails.
- **PyMuPDF:** For parsing text-based PDFs.
- **APScheduler:** Used for the hourly Correios tracking job.
- **openpyxl:** For creating and parsing  files.
- **pytesseract & Tesseract OCR:** For OCR on scanned PDFs.
- **Correios Rastro API:** For automatic package tracking.
- **ViaCEP:** For CEP lookup by address.

**Testing status**
- **Testing agent used after significant changes:** NO
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None
- **Known regressions:** None from this session's work.

**Credentials to test flow:**
- **Admin Login (João):**
  - **Email:** 
  - **Password:** 

**What agent forgot to execute**
- The agent has correctly identified the next steps but has only just begun the implementation. Nothing has been forgotten, but the new features are far from complete.</analysis>
